---
export const prerender = false;

import { pool } from '../../lib/db';
import '../../styles/global.css';


const shareCode = Astro.params.shareCode!;

// 1) Viaje
const tripRes = await pool.query(
  `SELECT id, name, origin_city, origin_airport_code, currency, share_code
   FROM trips WHERE share_code = $1`,
  [shareCode]
);
const trip = tripRes.rows[0];
if (!trip) {
  throw new Error('Viaje no encontrado');
}

// 2) Participantes (para elegir ‚Äúqui√©n eres‚Äù)
const participantsRes = await pool.query(
  `SELECT id, display_name, email, created_at
   FROM participants
   WHERE trip_id = $1
   ORDER BY created_at`,
  [trip.id]
);
const participants = participantsRes.rows;

// 3) ¬øHay sesi√≥n activa?
const sessionToken = Astro.cookies.get('eurotrip_session')?.value ?? null;
let participant: any = null;

if (sessionToken) {
  const sRes = await pool.query(
    `
    SELECT
      s.participant_id,
      p.display_name,
      p.email
    FROM participant_sessions s
    JOIN participants p ON p.id = s.participant_id
    WHERE
      s.session_token = $1
      AND s.trip_id = $2
      AND s.expires_at > now()
    `,
    [sessionToken, trip.id]
  );

  if (sRes.rowCount > 0) {
    const row = sRes.rows[0];
    participant = {
      id: row.participant_id,
      display_name: row.display_name,
      email: row.email,
    };
  }
}

// 4) Datos del viaje para votar
const weekendsRes = await pool.query(
  'SELECT id, start_date, end_date FROM weekends WHERE trip_id = $1 ORDER BY start_date',
  [trip.id]
);
const weekends = weekendsRes.rows;

const destRes = await pool.query(
  'SELECT id, name, country, airport_code FROM destinations WHERE trip_id = $1 ORDER BY name',
  [trip.id]
);
const destinations = destRes.rows;

// 5) Vuelos (para mostrar precios desde)
const flightsRes = await pool.query(
  `SELECT
     id,
     destination_id,
     weekend_id,
     direction,
     flight_date,
     option_rank,
     price_per_person,
     currency
   FROM flight_day_options
   WHERE trip_id = $1
   ORDER BY destination_id, weekend_id, direction, flight_date, option_rank`,
  [trip.id]
);
const flights = flightsRes.rows;

// 6) Datos del participante (si hay sesi√≥n): votos, rankings, sugerencias
let weekendVotes: any[] = [];
let destinationRanks: any[] = [];
let suggestions: any[] = [];

if (participant) {
  const wvRes = await pool.query(
    `SELECT weekend_id, availability, outbound_date, return_date
     FROM weekend_votes
     WHERE trip_id = $1 AND participant_id = $2`,
    [trip.id, participant.id]
  );
  weekendVotes = wvRes.rows;

  const drRes = await pool.query(
    `SELECT destination_id, priority
     FROM destination_rankings
     WHERE trip_id = $1 AND participant_id = $2`,
    [trip.id, participant.id]
  );
  destinationRanks = drRes.rows;

  const sugRes = await pool.query(
    `SELECT id, name, country, priority, created_at
     FROM participant_destination_suggestions
     WHERE trip_id = $1 AND participant_id = $2
     ORDER BY created_at`,
    [trip.id, participant.id]
  );
  suggestions = sugRes.rows;
}

// 7) Agrupaci√≥n de vuelos
type FlightRow = (typeof flights)[number];
const groupedFlights = new Map<string, FlightRow[]>();

for (const f of flights) {
  const key = `${f.destination_id}|${f.weekend_id}|${f.direction}|${f.flight_date.toISOString().slice(0,10)}`;
  if (!groupedFlights.has(key)) groupedFlights.set(key, []);
  groupedFlights.get(key)!.push(f);
}

function getFlightsFor(destId: number, weekendId: number, direction: string, dateStr: string): FlightRow[] {
  const key = `${destId}|${weekendId}|${direction}|${dateStr}`;
  return groupedFlights.get(key) ?? [];
}

function formatDate(d: Date) {
  return d.toLocaleDateString('es-ES', { weekday: 'short', day: '2-digit', month: 'short' });
}

function outboundDatesForWeekend(w: any) {
  return [
    new Date(w.start_date.getTime() - 2 * 24*60*60*1000),
    new Date(w.start_date.getTime() - 1 * 24*60*60*1000),
    w.start_date,
    new Date(w.start_date.getTime() + 1 * 24*60*60*1000),
  ];
}
function returnDatesForWeekend(w: any) {
  return [
    w.end_date,
    new Date(w.end_date.getTime() + 1 * 24*60*60*1000),
    new Date(w.end_date.getTime() + 2 * 24*60*60*1000),
    new Date(w.end_date.getTime() + 3 * 24*60*60*1000),
  ];
}

function findWeekendVote(weekendId: number) {
  return weekendVotes.find((w) => w.weekend_id === weekendId) ?? null;
}
function findDestinationRank(destId: number) {
  return destinationRanks.find((r) => r.destination_id === destId)?.priority ?? '';
}
---

<html lang="es">
  <head>
    <meta charset="utf-8" />
    <title>Votar viaje: {trip.name}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
      :root {
        --bg: #020617;
        --card: #020617;
        --card-border: #1e293b;
        --accent: #f97316;
        --accent-soft: rgba(249, 115, 22, 0.12);
        --accent-text: #fed7aa;
        --fg: #e5e7eb;
        --muted: #9ca3af;
        --good: #22c55e;
        --maybe: #eab308;
        --bad: #f97373;
      }

      * { box-sizing: border-box; }

      body {
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: radial-gradient(circle at top left, #0f172a, #020617 55%);
        color: var(--fg);
      }

      .shell {
        min-height: 100vh;
        padding: 1.5rem 1rem 3rem;
        max-width: 960px;
        margin: 0 auto;
      }

      header {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        margin-bottom: 1.5rem;
      }

      header h1 {
        font-size: 1.7rem;
        margin: 0;
      }

      header p {
        margin: 0;
        color: var(--muted);
        font-size: 0.95rem;
      }

      .chip {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.2rem 0.6rem;
        border-radius: 999px;
        background: var(--accent-soft);
        color: var(--accent-text);
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: .05em;
      }

      .card {
        border-radius: 1rem;
        border: 1px solid var(--card-border);
        background: radial-gradient(circle at top left, rgba(148, 163, 184, .18), transparent 55%);
        background-color: var(--card);
        padding: 1rem 1rem 1.3rem;
        box-shadow: 0 18px 40px rgba(15, 23, 42, 0.65);
      }

      .card h2 {
        margin: 0 0 0.65rem;
        font-size: 1.05rem;
      }

      .helper-text {
        font-size: 0.8rem;
        color: var(--muted);
        margin-top: 0.2rem;
      }

      .field {
        display: grid;
        gap: 0.3rem;
        font-size: 0.9rem;
        margin-bottom: 0.6rem;
      }

      select,
      input[type="password"],
      input[type="text"] {
        width: 100%;
        border-radius: 0.7rem;
        border: 1px solid #1f2937;
        background: #020617;
        color: var(--fg);
        padding: 0.5rem 0.7rem;
        font: inherit;
      }

      button {
        border-radius: 999px;
        border: none;
        padding: 0.7rem 1.1rem;
        font: inherit;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.4rem;
      }

      .btn-primary {
        background: linear-gradient(135deg, #f97316, #fb923c);
        color: #0b1120;
        width: 100%;
        margin-top: 1rem;
      }

      .layout-grid {
        display: grid;
        grid-template-columns: minmax(0, 1.1fr);
        gap: 1rem;
      }
      @media (min-width: 900px) {
        .layout-grid {
          grid-template-columns: minmax(0, 1.1fr) minmax(0, 1fr);
        }
      }

      .weekend-card {
        margin-top: 0.6rem;
        padding: 0.7rem 0.7rem;
        border-radius: 0.9rem;
        border: 1px solid #1f2937;
        background: rgba(15, 23, 42, 0.7);
      }

      .weekend-title {
        font-size: 0.95rem;
        font-weight: 600;
        margin-bottom: 0.25rem;
      }

      .weekend-chip-row {
        display: flex;
        flex-wrap: wrap;
        gap: 0.35rem;
        margin-bottom: 0.4rem;
        font-size: 0.8rem;
        color: var(--muted);
      }

      .pill-group {
        display: flex;
        gap: 0.3rem;
        margin: 0.25rem 0 0.45rem;
      }

      .pill {
        flex: 1;
        padding: 0.35rem 0.3rem;
        border-radius: 999px;
        border: 1px solid #1f2937;
        background: #020617;
        font-size: 0.8rem;
        text-align: center;
      }

      .pill input {
        display: none;
      }

      .pill span {
        pointer-events: none;
      }

      .pill--yes:has(input:checked) {
        border-color: #22c55e;
        background: rgba(34, 197, 94, 0.14);
      }

      .pill--maybe:has(input:checked) {
        border-color: #eab308;
        background: rgba(234, 179, 8, 0.14);
      }

      .pill--no:has(input:checked) {
        border-color: #f97373;
        background: rgba(248, 113, 113, 0.14);
      }

      .small-label {
        font-size: 0.78rem;
        color: var(--muted);
        margin-bottom: 0.2rem;
      }

      .dest-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.7rem;
        margin-bottom: 0.55rem;
        font-size: 0.9rem;
      }

      .dest-name {
        font-weight: 500;
      }

      .suggestion-row {
        display: grid;
        grid-template-columns: 1.3fr 1.1fr 0.7fr;
        gap: 0.4rem;
        align-items: center;
        margin-top: 0.4rem;
      }

      @media (max-width: 640px) {
        .suggestion-row {
          grid-template-columns: 1fr;
        }
      }

      .badge-counter {
        display:inline-flex;
        align-items:center;
        gap:0.35rem;
        font-size:0.8rem;
        color:var(--muted);
        margin-top:0.3rem;
      }
    </style>
  </head>
  <body>
    <div class="shell">
      <header>
        <div class="chip">Votaci√≥n de viaje</div>
        <h1>{trip.name}</h1>
        <p>
          Origen: <strong>{trip.origin_city}</strong>
          {trip.origin_airport_code && <> ({trip.origin_airport_code})</>}
          <br />
          Moneda: <strong>{trip.currency}</strong>
        </p>
      </header>

      {!participant ? (
        <!-- PANTALLA DE REGISTRO -->
        <main>
          <section class="card">
            <h2>Identif√≠cate como viajero</h2>
            <p class="helper-text">
              El organizador ha creado una lista de viajeros. Elige tu nombre y crea una contrase√±a para guardar tus votos.
            </p>

            {participants.length === 0 ? (
              <p style="margin-top:0.7rem;">El organizador a√∫n no ha a√±adido viajeros para este viaje.</p>
            ) : (
              <form
                method="POST"
                action="/api/auth/register"
                style="display:grid; gap:0.7rem; margin-top:0.7rem;"
              >
                <input type="hidden" name="tripId" value={trip.id} />
                <input type="hidden" name="shareCode" value={trip.share_code} />

                <div class="field">
                  <label>¬øQui√©n eres?</label>
                  <select name="participantId" required>
                    <option value="">Selecciona tu nombre...</option>
                    {participants.map((p) => (
                      <option value={p.id}>{p.display_name}</option>
                    ))}
                  </select>
                </div>

                <div class="field">
                  <label>Contrase√±a</label>
                  <input type="password" name="password" required minlength="4" />
                  <p class="helper-text">
                    Si es la primera vez que entras, esta ser√° tu contrase√±a.
                    Si ya has votado antes, introduce la misma contrase√±a que usaste.
                  </p>
                </div>

                <button type="submit" class="btn-primary">
                  Continuar
                </button>
              </form>
            )}
          </section>
        </main>
      ) : (
        <!-- PANTALLA DE VOTACI√ìN √öNICA -->
        <main class="layout-grid">
          <!-- IZQUIERDA: findes + derecha (todo en un solo form) -->
          <section class="card">
            <h2>Hola, {participant.display_name}</h2>
            <p class="helper-text">
              Marca tu disponibilidad para cada fin de semana y, si quieres, indica tus d√≠as preferidos de ida y vuelta.
            </p>

            <form
              id="vote-form"
              style="display:grid; gap:0.9rem; margin-top:0.8rem;"
              data-trip-id={trip.id}
              data-participant-id={participant.id}
              data-share-code={trip.share_code}
              data-weekend-ids={JSON.stringify(weekends.map((w) => w.id))}
              data-destination-ids={JSON.stringify(destinations.map((d) => d.id))}
            >
              {weekends.length === 0 ? (
                <p>No hay fines de semana definidos a√∫n.</p>
              ) : (
                weekends.map((w) => {
                  const vote = findWeekendVote(w.id);
                  const currentAvail = vote?.availability ?? 'maybe';

                  const outDates = outboundDatesForWeekend(w);
                  const retDates = returnDatesForWeekend(w);

                  return (
                    <div class="weekend-card">
                      <div class="weekend-title">
                        {formatDate(w.start_date)} ‚Äì {formatDate(w.end_date)}
                      </div>
                      <div class="weekend-chip-row">
                        <span>
                          Ida entre {formatDate(outDates[0])} y {formatDate(outDates[outDates.length - 1])}
                        </span>
                        <span>¬∑</span>
                        <span>
                          Vuelta entre {formatDate(retDates[0])} y {formatDate(retDates[retDates.length - 1])}
                        </span>
                      </div>

                      <div class="pill-group">
                        <label class="pill pill--yes">
                          <input
                            type="radio"
                            name={`availability_${w.id}`}
                            value="yes"
                            checked={currentAvail === 'yes'}
                          />
                          <span>‚úÖ Puedo</span>
                        </label>
                        <label class="pill pill--maybe">
                          <input
                            type="radio"
                            name={`availability_${w.id}`}
                            value="maybe"
                            checked={currentAvail === 'maybe'}
                          />
                          <span>ü§î Quiz√°s</span>
                        </label>
                        <label class="pill pill--no">
                          <input
                            type="radio"
                            name={`availability_${w.id}`}
                            value="no"
                            checked={currentAvail === 'no'}
                          />
                          <span>‚ùå No</span>
                        </label>
                      </div>

                      <!--<div style="display:grid; gap:0.35rem; margin-top:0.2rem;">
                        <div>
                          <div class="small-label">D√≠a de ida preferido (opcional)</div>
                          <select
                            name={`outboundDate_${w.id}`}
                            value={vote?.outbound_date?.toISOString?.().slice(0,10) ?? ''}
                          >
                            <option value="">Sin preferencia</option>
                            {outDates.map((dDate) => {
                              const ds = dDate.toISOString().slice(0,10);
                              const flightsForDay = destinations.length
                                ? getFlightsFor(destinations[0].id, w.id, 'outbound', ds)
                                : [];
                              const minPrice = flightsForDay[0]?.price_per_person;
                              const currency = flightsForDay[0]?.currency ?? trip.currency;

                              return (
                                <option value={ds}>
                                  {formatDate(dDate)}
                                  {minPrice ? ` ¬∑ desde ${minPrice} ${currency}` : ''}
                                </option>
                              );
                            })}
                          </select>
                        </div>
                        <div>
                          <div class="small-label">D√≠a de vuelta preferido (opcional)</div>
                          <select
                            name={`returnDate_${w.id}`}
                            value={vote?.return_date?.toISOString?.().slice(0,10) ?? ''}
                          >
                            <option value="">Sin preferencia</option>
                            {retDates.map((dDate) => {
                              const ds = dDate.toISOString().slice(0,10);
                              const flightsForDay = destinations.length
                                ? getFlightsFor(destinations[0].id, w.id, 'return', ds)
                                : [];
                              const minPrice = flightsForDay[0]?.price_per_person;
                              const currency = flightsForDay[0]?.currency ?? trip.currency;

                              return (
                                <option value={ds}>
                                  {formatDate(dDate)}
                                  {minPrice ? ` ¬∑ desde ${minPrice} ${currency}` : ''}
                                </option>
                              );
                            })}
                          </select>
                        </div>
                      </div>-->
                    </div>
                  );
                })
              )}

              <section class="card" style="margin-top:1rem;">
                <h2>Ciudades que te apetecen</h2>
                <p class="helper-text">
                  Ordena los destinos propuestos y a√±ade hasta 3 sugerencias con prioridad 1, 2 o 3.
                </p>

                {destinations.length === 0 ? (
                  <p style="margin-top:0.7rem;">Todav√≠a no hay destinos definidos por el organizador.</p>
                ) : (
                  <div style="margin-top:0.7rem;">
                    {destinations.map((d, idx) => (
                      <div class="dest-row">
                        <div>
                          <div class="dest-name">
                            {d.name}
                            {d.country && <> ‚Äì {d.country}</>}
                          </div>
                          {d.airport_code && (
                            <div class="helper-text" style="margin-top:0.1rem;">
                              Aeropuerto: {d.airport_code}
                            </div>
                          )}
                        </div>
                        <div style="min-width:4.5rem;">
                          <select
                            name={`destPriority_${d.id}`}
                            value={findDestinationRank(d.id)}
                          >
                            <option value="">‚Äî</option>
                            {destinations.map((_, i) => (
                              <option value={i + 1}>{i + 1}</option>
                            ))}
                          </select>
                        </div>
                      </div>
                    ))}
                    <p class="helper-text">
                      No tienes que rellenar todo, s√≥lo tus favoritas y su orden aproximado.
                    </p>
                  </div>
                )}

                <hr style="border:none; border-top:1px solid #1f2937; margin:1rem 0;" />

                <h2>Sugiere tus destinos (m√°x. 3)</h2>

                <div class="badge-counter">
                  <span>Has sugerido {suggestions.length} / 3 destinos.</span>
                  <span>Te quedan {3 - suggestions.length >= 0 ? (3 - suggestions.length) : 0} por usar.</span>
                </div>

                {Array.from({ length: 3 }).map((_, i) => {
                  const slot = suggestions[i] ?? null;
                  const slotIndex = i + 1;
                  const priorityValue = slot?.priority ?? '';

                  return (
                    <div class="suggestion-row">
                      <div>
                        <div class="small-label">Ciudad #{slotIndex}</div>
                        <input
                          type="text"
                          name={`sugName_${slotIndex}`}
                          value={slot?.name ?? ''}
                          placeholder="Ej: Budapest"
                        />
                      </div>
                      <div>
                        <div class="small-label">Pa√≠s (opcional)</div>
                        <input
                          type="text"
                          name={`sugCountry_${slotIndex}`}
                          value={slot?.country ?? ''}
                          placeholder="Ej: Hungr√≠a"
                        />
                      </div>
                      <div>
                        <div class="small-label">Prioridad</div>
                        <select
                          name={`sugPriority_${slotIndex}`}
                          value={priorityValue}
                        >
                          <option value="">Autom√°tica</option>
                          <option value="1">1 (m√°s ganas)</option>
                          <option value="2">2</option>
                          <option value="3">3</option>
                        </select>
                      </div>
                    </div>
                  );
                })}

                <p class="helper-text" style="margin-top:0.5rem;">
                  Si no asignas prioridad, se ordenar√°n autom√°ticamente por orden de entrada (1, 2 y 3).
                </p>
              </section>

              <button type="submit" class="btn-primary">
                Guardar tu votaci√≥n
              </button>
            </form>
          </section>
        </main>
      )}
    </div>

    {participant && (
      <script type="module">
        const form = document.getElementById('vote-form');
        if (form) {
          form.addEventListener('submit', async (event) => {
            event.preventDefault();

            const tripId = Number(form.dataset.tripId);
            const participantId = Number(form.dataset.participantId);

            const weekendIds = JSON.parse(form.dataset.weekendIds || '[]');
            const destinationIds = JSON.parse(form.dataset.destinationIds || '[]');

            const weekendVotes = [];
            weekendIds.forEach((id) => {
              const availabilityInput = form.querySelector(
                `input[name="availability_${id}"]:checked`
              );
              const availability = availabilityInput ? availabilityInput.value : 'maybe';

              const outSelect = form.querySelector(
                `select[name="outboundDate_${id}"]`
              );
              const retSelect = form.querySelector(
                `select[name="returnDate_${id}"]`
              );

              const outboundDate = outSelect && outSelect.value
                ? outSelect.value
                : null;
              const returnDate = retSelect && retSelect.value
                ? retSelect.value
                : null;

              weekendVotes.push({
                weekendId: Number(id),
                availability,
                outboundDate,
                returnDate,
              });
            });

            const destinationRankings = [];
            destinationIds.forEach((id) => {
              const sel = form.querySelector(
                `select[name="destPriority_${id}"]`
              );
              if (!sel) return;
              const val = sel.value;
              if (!val) return;
              const priority = Number(val);
              if (!priority) return;

              destinationRankings.push({
                destinationId: Number(id),
                priority,
              });
            });

            const suggestions = [];
            for (let i = 1; i <= 3; i++) {
              const nameInput = form.querySelector(
                `input[name="sugName_${i}"]`
              );
              const countryInput = form.querySelector(
                `input[name="sugCountry_${i}"]`
              );
              const prioritySelect = form.querySelector(
                `select[name="sugPriority_${i}"]`
              );

              const name = nameInput ? nameInput.value.trim() : '';
              if (!name) continue;

              const country = countryInput
                ? countryInput.value.trim()
                : '';
              const pVal = prioritySelect ? prioritySelect.value : '';
              const priority = pVal ? Number(pVal) : null;

              suggestions.push({
                name,
                country: country || null,
                priority,
              });
            }

            const payload = {
              tripId,
              participantId,
              weekendVotes,
              destinationRankings,
              suggestions,
            };

            try {
              const res = await fetch('/api/vote', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload),
              });

              if (!res.ok) {
                const txt = await res.text();
                console.error('Error en /api/vote:', res.status, txt);
                alert('Error guardando tu votaci√≥n');
                return;
              }

              // Ir a pantalla de resultados
              window.location.href = window.location.pathname + '/results';
            } catch (err) {
              console.error('Error de red en /api/vote:', err);
              alert('Error de red guardando tu votaci√≥n');
            }
          });
        }
      </script>
    )}
  </body>
</html>
