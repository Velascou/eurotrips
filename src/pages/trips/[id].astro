---
export const prerender = false;

import { pool } from '../../lib/db';

const idParam = Astro.params.id;
const tripId = Number(idParam);

if (!tripId || Number.isNaN(tripId)) {
  throw new Error('ID de viaje inv√°lido');
}

// 1) Cargar viaje
const tripRes = await pool.query(
  'SELECT id, name, origin_city, origin_airport_code, currency, share_code, created_at FROM trips WHERE id = $1',
  [tripId]
);
const trip = tripRes.rows[0];

if (!trip) {
  throw new Error('Viaje no encontrado');
}

// 2) Cargar destinos
const destRes = await pool.query(
  'SELECT id, name, country, airport_code FROM destinations WHERE trip_id = $1 ORDER BY name',
  [tripId]
);
const destinations = destRes.rows;

// 3) Cargar fines de semana
const weekendsRes = await pool.query(
  'SELECT id, start_date, end_date FROM weekends WHERE trip_id = $1 ORDER BY start_date',
  [tripId]
);
const weekends = weekendsRes.rows;

// 4) Cargar vuelos (si ya hay algo en flight_day_options)
const flightsRes = await pool.query(
  `SELECT
     id,
     destination_id,
     weekend_id,
     direction,
     flight_date,
     option_rank,
     price_per_person,
     currency,
     airline,
     carrier_code,
     flight_number,
     departure_time,
     arrival_time,
     departure_airport,
     arrival_airport,
     booking_url
   FROM flight_day_options
   WHERE trip_id = $1
   ORDER BY destination_id, weekend_id, direction, flight_date, option_rank`,
  [tripId]
);

const flights = flightsRes.rows;

// 5) Participantes
// debajo de donde cargas trip/destinations/weekends...
const participantsRes = await pool.query(
  `SELECT id, display_name, email, created_at
   FROM participants
   WHERE trip_id = $1
   ORDER BY created_at`,
  [tripId]
);
const participants = participantsRes.rows;


// 6) Resumen de disponibilidad por finde
const weekendStatsRes = await pool.query(
  `
  SELECT
    w.id,
    w.start_date,
    w.end_date,
    COALESCE(SUM(CASE WHEN v.availability = 'yes'   THEN 1 ELSE 0 END), 0) AS yes_count,
    COALESCE(SUM(CASE WHEN v.availability = 'maybe' THEN 1 ELSE 0 END), 0) AS maybe_count,
    COALESCE(SUM(CASE WHEN v.availability = 'no'    THEN 1 ELSE 0 END), 0) AS no_count
  FROM weekends w
  LEFT JOIN weekend_votes v
    ON v.weekend_id = w.id
    AND v.trip_id    = w.trip_id
  WHERE w.trip_id = $1
  GROUP BY w.id, w.start_date, w.end_date
  ORDER BY w.start_date
  `,
  [tripId]
);
const weekendStats = weekendStatsRes.rows;

// 7) Resumen de ranking de destinos
const destStatsRes = await pool.query(
  `
  SELECT
    d.id,
    d.name,
    d.country,
    COUNT(r.*)                         AS voters,
    AVG(r.priority)::numeric(10,2)     AS avg_priority
  FROM destinations d
  LEFT JOIN destination_rankings r
    ON r.destination_id = d.id
    AND r.trip_id       = d.trip_id
  WHERE d.trip_id = $1
  GROUP BY d.id, d.name, d.country
  ORDER BY avg_priority ASC NULLS LAST, d.name
  `,
  [tripId]
);
const destinationStats = destStatsRes.rows;

// Agrupar vuelos por destino + finde + direcci√≥n + d√≠a
type FlightGroupKey = string;
type FlightRow = (typeof flights)[number];

const groupedFlights = new Map<FlightGroupKey, FlightRow[]>();

for (const f of flights) {
  const key = `${f.destination_id}|${f.weekend_id}|${f.direction}|${f.flight_date.toISOString().slice(0,10)}`;
  if (!groupedFlights.has(key)) {
    groupedFlights.set(key, []);
  }
  groupedFlights.get(key)!.push(f);
}

// Helper para encontrar vuelos para un destino+finde+direction+date
function getFlightsFor(destId: number, weekendId: number, direction: string, dateStr: string): FlightRow[] {
  const key = `${destId}|${weekendId}|${direction}|${dateStr}`;
  return groupedFlights.get(key) ?? [];
}

function formatDate(d: Date) {
  return d.toLocaleDateString('es-ES', { weekday: 'short', day: '2-digit', month: 'short' });
}

// ==== Helpers para sugerencias r√°pidas de fines de semana ====
function toYMD(d: Date) {
  return d.toISOString().slice(0, 10);
}

function addDays(d: Date, days: number) {
  const nd = new Date(d);
  nd.setDate(nd.getDate() + days);
  return nd;
}

function getNextFriday(from = new Date()): Date {
  const d = new Date(from);
  const day = d.getDay(); // 0=domingo, 1=lunes,...,5=viernes
  const diff = (5 - day + 7) % 7;
  // si hoy ya es viernes, saltar al siguiente para no meter el mismo finde
  return addDays(d, diff === 0 ? 7 : diff);
}

// Evitar sugerir findes que ya existen en la BD
const existingStarts = new Set(
  weekends.map((w: any) =>
    w.start_date instanceof Date ? toYMD(w.start_date) : String(w.start_date).slice(0, 10)
  )
);

function formatTimeEs(t: any) {
  if (!t) return '';
  const s = String(t);        // suele venir 'HH:MM:SS'
  return s.slice(0, 5);       // 'HH:MM' 24h
}

// Pr√≥ximos 24 findes (viernes-domingo), excluyendo los ya guardados
const suggestedWeekends = (() => {
  const list: { start: string; end: string }[] = [];
  let currentFriday = getNextFriday();
  const count = 24;

  for (let i = 0; i < count; i++) {
    const start = currentFriday;
    const end = addDays(start, 2); // domingo
    const startStr = toYMD(start);
    const endStr = toYMD(end);

    if (!existingStarts.has(startStr)) {
      list.push({ start: startStr, end: endStr });
    }

    currentFriday = addDays(currentFriday, 7);
  }

  return list;
})();
---

<html lang="es">
  <head>
    <meta charset="utf-8" />
    <title>Viaje: {trip.name}</title>
  </head>
  <body style="font-family: system-ui; max-width: 1000px; margin: 2rem auto; line-height: 1.5;">
    <a href="/trips" style="text-decoration:none;">‚¨Ö Volver a la lista</a>

    <h1 style="margin-top: 1rem;">{trip.name}</h1>
    <p>
      Origen:
      <strong>
        {trip.origin_city}
        {trip.origin_airport_code && <> ({trip.origin_airport_code})</>}
      </strong>
      <br />
      Moneda: <strong>{trip.currency}</strong>
      <br />
      Creado: {new Date(trip.created_at).toLocaleString('es-ES')}
      <br />
      Enlace para compartir con tus amigos:<br />
      <code>/join/{trip.share_code}</code>
    </p>

        <!-- Secci√≥n: a√±adir destinos -->
    <section style="margin-top: 2rem;">
      <h2>Destinos</h2>

      {destinations.length === 0 ? (
        <p>A√∫n no hay destinos para este viaje.</p>
      ) : (
        <ul>
          {destinations.map((d) => (
            <li key={d.id}>
              <strong>{d.name}</strong>
              {d.country && <> ‚Äì {d.country}</>}
              {d.airport_code && <> ({d.airport_code})</>}
              {/* Bot√≥n eliminar destino */}
              <form
                method="POST"
                action="/api/destinations/delete"
                style="display:inline; margin-left:0.5rem;"
              >
                <input type="hidden" name="tripId" value={trip.id} />
                <input type="hidden" name="destinationId" value={d.id} />
                <button
                  type="submit"
                  style="border:none; background:none; color:#c00; cursor:pointer; font-size:0.85rem;"
                >
                  eliminar
                </button>
              </form>
            </li>
          ))}
        </ul>
      )}

      <h3>A√±adir destino</h3>
      <form method="POST" action="/api/destinations" style="display:grid; gap:0.5rem; max-width:400px;">
        <input type="hidden" name="tripId" value={trip.id} />
        <label>
          Nombre de la ciudad<br />
          <input name="name" required style="width:100%; padding:0.3rem;" />
        </label>
        <label>
          Pa√≠s<br />
          <input name="country" style="width:100%; padding:0.3rem;" />
        </label>
        <label>
          C√≥digo de aeropuerto (IATA, ej: FCO, BUD) ‚Äì opcional<br />
          <input name="airportCode" style="width:100%; padding:0.3rem;" />
        </label>
        <button type="submit" style="margin-top:0.5rem; padding:0.4rem 0.8rem;">
          Guardar destino
        </button>
      </form>
    </section>


    <!-- Secci√≥n: fines de semana -->
    <section style="margin-top: 2rem;">
      <h2>Fines de semana</h2>

      {weekends.length === 0 ? (
        <p>A√∫n no hay fines de semana definidos.</p>
      ) : (
        <ul>
          {weekends.map((w) => (
            <li key={w.id}>
              <strong>{formatDate(w.start_date)} - {formatDate(w.end_date)}</strong>
              <!-- Bot√≥n eliminar finde -->
              <form
                method="POST"
                action="/api/weekends/delete"
                style="display:inline; margin-left:0.5rem;"
              >
                <input type="hidden" name="tripId" value={trip.id} />
                <input type="hidden" name="weekendId" value={w.id} />
                <button
                  type="submit"
                  style="border:none; background:none; color:#c00; cursor:pointer; font-size:0.85rem;"
                >
                  eliminar
                </button>
              </form>
            </li>
          ))}
        </ul>
      )}

      <h3>Sugerencias r√°pidas (pr√≥ximos findes)</h3>
      <div style="display:flex; flex-wrap:wrap; gap:0.5rem; margin-bottom:1rem;">
        {suggestedWeekends.map((sw) => (
          <form
            method="POST"
            action="/api/weekends"
            style="margin:0;"
          >
            <input type="hidden" name="tripId" value={trip.id} />
            <input type="hidden" name="startDate" value={sw.start} />
            <input type="hidden" name="endDate" value={sw.end} />
            <button
              type="submit"
              style="padding:0.3rem 0.6rem; border-radius:999px; border:1px solid #ccc; background:#f9f9f9; cursor:pointer;"
            >
              {formatDate(new Date(sw.start))} ‚Äì {formatDate(new Date(sw.end))}
            </button>
          </form>
        ))}
      </div>

      <h3>A√±adir fin de semana manualmente</h3>
      <form method="POST" action="/api/weekends" style="display:grid; gap:0.5rem; max-width:400px;">
        <input type="hidden" name="tripId" value={trip.id} />
        <label>
          Fecha de inicio (viernes)<br />
          <input type="date" name="startDate" required style="width:100%; padding:0.3rem;" />
        </label>
        <label>
          Fecha de fin (domingo)<br />
          <input type="date" name="endDate" required style="width:100%; padding:0.3rem;" />
        </label>
        <button type="submit" style="margin-top:0.5rem; padding:0.4rem 0.8rem;">
          Guardar fin de semana
        </button>
      </form>
    </section>

    <!-- Bot√≥n para refrescar vuelos -->
    <section style="margin-top: 2rem;">
      <h2>Vuelos</h2>
      <form method="POST" action={`/api/trips/${trip.id}/refresh-flights`}>
        <button type="submit" style="padding:0.5rem 1rem;">
          Actualizar vuelos (API)
        </button>
      </form>

      {destinations.length === 0 || weekends.length === 0 ? (
        <p style="margin-top:1rem;">
          A√±ade al menos un destino y un fin de semana para ver opciones de vuelo.
        </p>
      ) : flights.length === 0 ? (
        <p style="margin-top:1rem;">
          A√∫n no hay datos de vuelos guardados. Pulsa en "Actualizar vuelos" cuando tengas la API configurada.
        </p>
      ) : (
        <>
          {destinations.map((d) => (
            <div key={d.id} style="margin-top:1.5rem; padding:1rem; border:1px solid #ddd; border-radius:8px;">
              <h3 style="margin-top:0;">
                {d.name}
                {d.airport_code && <> ({d.airport_code})</>}
              </h3>

              {weekends.map((w) => {
                const outboundDates = [
                  new Date(w.start_date.getTime() - 2 * 24*60*60*1000),
                  new Date(w.start_date.getTime() - 1 * 24*60*60*1000),
                  w.start_date,
                  new Date(w.start_date.getTime() + 1 * 24*60*60*1000),
                ];
                const returnDates = [
                  w.end_date,
                  new Date(w.end_date.getTime() + 1 * 24*60*60*1000),
                  new Date(w.end_date.getTime() + 2 * 24*60*60*1000),
                  new Date(w.end_date.getTime() + 3 * 24*60*60*1000),
                ];

                return (
                  <div key={w.id} style="margin-top:1rem;">
                    <h4>
                      Finde: {formatDate(w.start_date)} - {formatDate(w.end_date)}
                    </h4>

                    <div style="display:flex; gap:2rem; flex-wrap:wrap;">
                      <div>
                        <strong>Ida</strong>
                        <ul>
                          {outboundDates.map((dDate) => {
                            const dateStr = dDate.toISOString().slice(0,10);
                            const dayFlights = getFlightsFor(d.id, w.id, 'outbound', dateStr);
                            const minPrice = dayFlights[0]?.price_per_person;

                            return (
                              <li key={'out-'+dateStr}>
                                {formatDate(dDate)}{' '}
                                {dayFlights.length === 0 ? (
                                  <>‚Äì sin datos</>
                                ) : (
                                  <>
                                    ‚Äì desde {minPrice} {dayFlights[0].currency}
                                    <ul>
                                      {dayFlights.map((f) => (
                                        <li key={f.id}>
                                          {f.airline || f.carrier_code || 'Vuelo'}
                                          {f.flight_number && <> {f.flight_number}</>}:{' '}
                                          {formatTimeEs(f.departure_time)} ‚Üí {formatTimeEs(f.arrival_time)} ¬∑{' '}
                                          {f.price_per_person} {f.currency}
                                        </li>
                                      ))}
                                    </ul>
                                  </>
                                )}
                              </li>
                            );
                          })}
                        </ul>
                      </div>

                      <div>
                        <strong>Vuelta</strong>
                        <ul>
                          {returnDates.map((dDate) => {
                            const dateStr = dDate.toISOString().slice(0,10);
                            const dayFlights = getFlightsFor(d.id, w.id, 'return', dateStr);
                            const minPrice = dayFlights[0]?.price_per_person;

                            return (
                              <li key={'ret-'+dateStr}>
                                {formatDate(dDate)}{' '}
                                {dayFlights.length === 0 ? (
                                  <>‚Äì sin datos</>
                                ) : (
                                  <>
                                    ‚Äì desde {minPrice} {dayFlights[0].currency}
                                    <ul>
                                      {dayFlights.map((f) => (
                                        <li key={f.id}>
                                          {f.airline || f.carrier_code || 'Vuelo'}
                                          {f.flight_number && <> {f.flight_number}</>}:{' '}
                                          {formatTimeEs(f.departure_time)} ‚Üí {formatTimeEs(f.arrival_time)} ¬∑{' '}
                                          {f.price_per_person} {f.currency}
                                        </li>
                                      ))}
                                    </ul>
                                  </>
                                )}
                              </li>
                            );
                          })}
                        </ul>
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>
          ))}
        </>
      )}
    </section>

        <section style="margin-top: 2rem;">
      <h2>Viajeros</h2>

      {participants.length === 0 ? (
        <p>A√∫n no hay viajeros definidos para este viaje.</p>
      ) : (
        <ul>
          {participants.map((p) => (
            <li key={p.id}>
              <strong>{p.display_name}</strong>
              {p.email && <> ‚Äì {p.email}</>}
              <span style="color:#666; font-size:0.85rem;">
                {' '}({new Date(p.created_at).toLocaleString('es-ES')})
              </span>
              <form
                method="POST"
                action="/api/participants/delete"
                style="display:inline; margin-left:0.5rem;"
              >
                <input type="hidden" name="tripId" value={trip.id} />
                <input type="hidden" name="participantId" value={p.id} />
                <button
                  type="submit"
                  style="border:none; background:none; color:#c00; cursor:pointer; font-size:0.85rem;"
                >
                  eliminar
                </button>
              </form>
            </li>
          ))}
        </ul>
      )}

      <h3>A√±adir viajero</h3>
      <form method="POST" action="/api/participants" style="display:grid; gap:0.5rem; max-width:400px;">
        <input type="hidden" name="tripId" value={trip.id} />
        <label>
          Nombre<br />
          <input name="displayName" required style="width:100%; padding:0.3rem;" />
        </label>
        <label>
          Email (opcional)<br />
          <input name="email" type="email" style="width:100%; padding:0.3rem;" />
        </label>
        <button type="submit" style="margin-top:0.5rem; padding:0.4rem 0.8rem;">
          Guardar viajero
        </button>
      </form>
    </section>



     <!-- Participantes -->
    <section style="margin-top: 3rem;">
      <h2>Participantes</h2>
      {participants.length === 0 ? (
        <p>A√∫n no hay nadie apuntado usando el enlace de invitaci√≥n.</p>
      ) : (
        <ul>
          {participants.map((p) => (
            <li key={p.id}>
              <strong>{p.display_name}</strong>
              {p.email && <> ‚Äì {p.email}</>}
              <span style="color:#666; font-size:0.85rem;">
                {' '}({new Date(p.created_at).toLocaleString('es-ES')})
              </span>
            </li>
          ))}
        </ul>
      )}
    </section>

    <!-- Resumen de fines de semana -->
    <section style="margin-top: 2rem;">
      <h2>Resumen disponibilidad por finde</h2>
      {weekendStats.length === 0 ? (
        <p>No hay fines de semana ni votos todav√≠a.</p>
      ) : (
        <table style="width:100%; border-collapse:collapse; font-size:0.9rem;">
          <thead>
            <tr>
              <th style="text-align:left; padding:0.3rem; border-bottom:1px solid #ccc;">Finde</th>
              <th style="text-align:center; padding:0.3rem; border-bottom:1px solid #ccc;">‚úÖ Pueden</th>
              <th style="text-align:center; padding:0.3rem; border-bottom:1px solid #ccc;">ü§î Quiz√°s</th>
              <th style="text-align:center; padding:0.3rem; border-bottom:1px solid #ccc;">‚ùå No</th>
            </tr>
          </thead>
          <tbody>
            {weekendStats.map((w) => (
              <tr key={w.id}>
                <td style="padding:0.3rem; border-bottom:1px solid #eee;">
                  {formatDate(w.start_date)} ‚Äì {formatDate(w.end_date)}
                </td>
                <td style="text-align:center; padding:0.3rem; border-bottom:1px solid #eee;">
                  {w.yes_count}
                </td>
                <td style="text-align:center; padding:0.3rem; border-bottom:1px solid #eee;">
                  {w.maybe_count}
                </td>
                <td style="text-align:center; padding:0.3rem; border-bottom:1px solid #eee;">
                  {w.no_count}
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      )}
    </section>

    <!-- Resumen destinos -->
    <section style="margin-top: 2rem; margin-bottom:3rem;">
      <h2>Ranking de destinos</h2>
      {destinationStats.length === 0 ? (
        <p>No hay destinos o a√∫n no hay rankings.</p>
      ) : (
        <table style="width:100%; border-collapse:collapse; font-size:0.9rem;">
          <thead>
            <tr>
              <th style="text-align:left; padding:0.3rem; border-bottom:1px solid #ccc;">Destino</th>
              <th style="text-align:center; padding:0.3rem; border-bottom:1px solid #ccc;">Votos</th>
              <th style="text-align:center; padding:0.3rem; border-bottom:1px solid #ccc;">Prioridad media</th>
            </tr>
          </thead>
          <tbody>
            {destinationStats.map((d) => (
              <tr key={d.id}>
                <td style="padding:0.3rem; border-bottom:1px solid #eee;">
                  <strong>{d.name}</strong>
                  {d.country && <> ‚Äì {d.country}</>}
                </td>
                <td style="text-align:center; padding:0.3rem; border-bottom:1px solid #eee;">
                  {d.voters}
                </td>
                <td style="text-align:center; padding:0.3rem; border-bottom:1px solid #eee;">
                  {d.avg_priority ? Number(d.avg_priority).toFixed(2) : '‚Äî'}
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      )}
    </section>


  </body>
</html>